-- First, define all ENUM types for data integrity
CREATE TYPE "MEMBERSHIP_TYPE" AS ENUM ('DONOR', 'MEMBER', 'VOLUNTEER', 'AUDITOR', 'ADMIN');
CREATE TYPE "MEDIA_TYPE" AS ENUM ('PICTURE', 'VIDEO');
CREATE TYPE "CONTACT_TYPE" AS ENUM ('EMAIL', 'PHONE', 'WHATSAPP');
CREATE TYPE "PROJECT_STATUS" AS ENUM ('PLANNING', 'IN_PROGRESS', 'COMPLETED', 'ON_HOLD', 'CANCELLED');
CREATE TYPE "EVENT_STATUS" AS ENUM ('UPCOMING', 'ONGOING', 'COMPLETED', 'CANCELLED');
CREATE TYPE "PAYMENT_METHOD" AS ENUM ('CREDIT_CARD', 'BANK_TRANSFER', 'MOBILE_MONEY', 'CASH');
CREATE TYPE "TRANSACTION_STATUS" AS ENUM ('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED');
CREATE TYPE "ATTENDANCE_STATUS" AS ENUM ('INVITED', 'ACCEPTED', 'DECLINED', 'ATTENDED');
CREATE TYPE "GENDER" AS ENUM ('MALE', 'FEMALE', 'OTHER'); -- Added from enums file

--------------------------------------------------
-- Users, Auth & Notifications
--------------------------------------------------

CREATE TABLE "users" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "email" VARCHAR(255) UNIQUE NOT NULL,
    "password" TEXT,
    "username" TEXT UNIQUE,
    "google_id" TEXT UNIQUE,
    "apple_id" TEXT UNIQUE,
    "facebook_id" TEXT UNIQUE,
    "created_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE TABLE "otps" (
    "id" SERIAL PRIMARY KEY,
    "email" VARCHAR(255) NOT NULL,
    "code" TEXT NOT NULL,
    "payload" JSONB,
    "expires_at" TIMESTAMP WITH TIME ZONE NOT NULL,
    "is_used" BOOLEAN NOT NULL DEFAULT FALSE
);

CREATE TABLE "notifications" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "user_id" UUID NOT NULL REFERENCES "users"("id") ON DELETE CASCADE,
    "title" TEXT,
    "message" TEXT,
    "announcement_id" UUID, -- FK added in communications section
    "is_read" BOOLEAN NOT NULL DEFAULT FALSE,
    "created_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

--------------------------------------------------
-- Core Data
--------------------------------------------------

CREATE TABLE "media" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "url" TEXT NOT NULL,
    "media_type" "MEDIA_TYPE" NOT NULL,
    "created_by" UUID, -- FK to constituents
    "created_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE TABLE "constituents" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "user_id" UUID UNIQUE REFERENCES "users"("id") ON DELETE SET NULL,
    "first_name" TEXT NOT NULL,
    "last_name" TEXT NOT NULL,
    "preferred_name" TEXT,
    "selfie_id" UUID REFERENCES "media"("id") ON DELETE SET NULL,
    "salutation" TEXT,
    "date_of_birth" DATE,
    "gender" "GENDER",
    "join_date" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "created_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- Add missing FK from media to constituents
ALTER TABLE "media" ADD FOREIGN KEY ("created_by") REFERENCES "constituents"("id") ON DELETE SET NULL;

CREATE TABLE "contact_informations" (
    "id" SERIAL PRIMARY KEY,
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "contact_type" "CONTACT_TYPE" NOT NULL,
    "value" TEXT NOT NULL,
    "is_primary" BOOLEAN NOT NULL DEFAULT FALSE,
    UNIQUE ("constituent_id", "contact_type", "value")
);

CREATE TABLE "memberships" (
    "id" SERIAL PRIMARY KEY,
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "type" "MEMBERSHIP_TYPE" NOT NULL,
    "start_date" TIMESTAMP WITH TIME ZONE NOT NULL,
    "end_date" TIMESTAMP WITH TIME ZONE,
    "assigner_id" UUID REFERENCES "constituents"("id") ON DELETE SET NULL
);

CREATE TABLE "chapters" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT NOT NULL,
    "country" TEXT NOT NULL,
    "description" TEXT,
    "founding_date" DATE NOT NULL,
    "is_active" BOOLEAN NOT NULL DEFAULT TRUE,
    "parent_id" UUID REFERENCES "chapters"("id") ON DELETE SET NULL
);

CREATE TABLE "chapter_memberships" (
    "id" SERIAL PRIMARY KEY,
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "chapter_id" UUID NOT NULL REFERENCES "chapters"("id") ON DELETE CASCADE,
    "start_date" TIMESTAMP WITH TIME ZONE NOT NULL,
    "end_date" TIMESTAMP WITH TIME ZONE,
    "is_active" BOOLEAN NOT NULL DEFAULT TRUE,
    UNIQUE ("constituent_id", "chapter_id")
);

CREATE TABLE "committees" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT UNIQUE NOT NULL,
    "description" TEXT
);

CREATE TABLE "committee_memberships" (
    "id" SERIAL PRIMARY KEY,
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "committee_id" UUID NOT NULL REFERENCES "committees"("id") ON DELETE CASCADE,
    "start_date" TIMESTAMP WITH TIME ZONE NOT NULL,
    "end_date" TIMESTAMP WITH TIME ZONE,
    "is_active" BOOLEAN NOT NULL DEFAULT TRUE,
    UNIQUE ("constituent_id", "committee_id")
);

CREATE TABLE "roles" (
    "id" SERIAL PRIMARY KEY,
    "name" TEXT UNIQUE NOT NULL,
    "description" TEXT
);

CREATE TABLE "role_assignments" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "role_id" INTEGER NOT NULL REFERENCES "roles"("id") ON DELETE CASCADE,
    "chapter_id" UUID REFERENCES "chapters"("id") ON DELETE CASCADE,
    "committee_id" UUID REFERENCES "committees"("id") ON DELETE CASCADE,
    "started_at" TIMESTAMP WITH TIME ZONE NOT NULL,
    "ended_at" TIMESTAMP WITH TIME ZONE
);

--------------------------------------------------
-- Activities
--------------------------------------------------

CREATE TABLE "projects" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "chapter_id" UUID REFERENCES "chapters"("id") ON DELETE SET NULL,
    "project_name" TEXT NOT NULL,
    "project_objective" TEXT,
    "start_date" TIMESTAMP WITH TIME ZONE NOT NULL,
    "end_date" TIMESTAMP WITH TIME ZONE,
    "budget" DECIMAL(12, 2),
    "status" "PROJECT_STATUS" NOT NULL DEFAULT 'PLANNING'
);

CREATE TABLE "events" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "project_id" UUID REFERENCES "projects"("id") ON DELETE SET NULL,
    "event_name" TEXT NOT NULL,
    "event_date" TIMESTAMP WITH TIME ZONE NOT NULL,
    "event_location" TEXT,
    "event_objectives" TEXT,
    "status" "EVENT_STATUS" NOT NULL DEFAULT 'UPCOMING'
);

CREATE TABLE "event_participations" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- Changed to UUID from SERIAL
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "event_id" UUID NOT NULL REFERENCES "events"("id") ON DELETE CASCADE,
    "volunteer_hours" DECIMAL(5, 2),
    "role_during_event" TEXT,
    UNIQUE("constituent_id", "event_id")
);

--------------------------------------------------
-- Finance
--------------------------------------------------

CREATE TABLE "financial_transactions" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "amount" DECIMAL(10, 2) NOT NULL,
    "currency" VARCHAR(3) NOT NULL,
    "transaction_date" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "payment_method" "PAYMENT_METHOD" NOT NULL,
    "status" "TRANSACTION_STATUS" NOT NULL DEFAULT 'PENDING',
    "external_ref" TEXT
);

CREATE TABLE "designations" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT UNIQUE NOT NULL,
    "is_restricted" BOOLEAN NOT NULL DEFAULT FALSE,
    "description" TEXT
);

CREATE TABLE "donations" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "transaction_id" UUID UNIQUE NOT NULL REFERENCES "financial_transactions"("id") ON DELETE RESTRICT,
    "donor_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE RESTRICT,
    "project_id" UUID REFERENCES "projects"("id") ON DELETE SET NULL,
    "event_id" UUID REFERENCES "events"("id") ON DELETE SET NULL,
    "designation_id" UUID REFERENCES "designations"("id") ON DELETE SET NULL,
    "receipt_sent" BOOLEAN NOT NULL DEFAULT FALSE
);

CREATE TABLE "dues" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "membership_type" "MEMBERSHIP_TYPE" NOT NULL,
    "chapter_id" UUID REFERENCES "chapters"("id") ON DELETE SET NULL,
    "amount" DECIMAL(10, 2) NOT NULL,
    "currency" VARCHAR(3) NOT NULL,
    "period_start" DATE NOT NULL,
    "period_end" DATE NOT NULL
);

CREATE TABLE "dues_payments" (
    "id" SERIAL PRIMARY KEY,
    "transaction_id" UUID UNIQUE NOT NULL REFERENCES "financial_transactions"("id") ON DELETE RESTRICT,
    "dues_id" UUID NOT NULL REFERENCES "dues"("id") ON DELETE RESTRICT,
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE RESTRICT
);

CREATE TABLE "vendors" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT UNIQUE NOT NULL
);

CREATE TABLE "expenditures" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "expenditure_date" TIMESTAMP WITH TIME ZONE NOT NULL,
    "amount" DECIMAL(12, 2) NOT NULL,
    "currency" VARCHAR(3) NOT NULL,
    "description" TEXT NOT NULL,
    "category" TEXT,
    "project_id" UUID REFERENCES "projects"("id") ON DELETE RESTRICT,
    "event_id" UUID REFERENCES "events"("id") ON DELETE SET NULL,
    "vendor_id" UUID REFERENCES "vendors"("id") ON DELETE SET NULL,
    "approved_by_id" UUID REFERENCES "constituents"("id") ON DELETE RESTRICT
);

--------------------------------------------------
-- Impact
--------------------------------------------------

CREATE TABLE "impact_areas" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "area_name" TEXT UNIQUE NOT NULL,
    "description" TEXT
);

CREATE TABLE "impact_reports" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "project_id" UUID NOT NULL REFERENCES "projects"("id") ON DELETE RESTRICT,
    "report_title" TEXT NOT NULL,
    "narrative" TEXT NOT NULL,
    "date_created" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "created_by_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE RESTRICT
);

CREATE TABLE "outcomes" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "impact_area_id" UUID NOT NULL REFERENCES "impact_areas"("id") ON DELETE RESTRICT,
    "project_id" UUID NOT NULL REFERENCES "projects"("id") ON DELETE CASCADE,
    "outcome_name" TEXT NOT NULL,
    "target_value" DECIMAL(12, 2),
    "is_quantitative" BOOLEAN NOT NULL
);

CREATE TABLE "metrics" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "outcome_id" UUID NOT NULL REFERENCES "outcomes"("id") ON DELETE CASCADE,
    "measurement_date" DATE NOT NULL,
    "value" DECIMAL(12, 2) NOT NULL,
    "notes" TEXT,
    "data_source" TEXT
);

--------------------------------------------------
-- Communications
--------------------------------------------------

CREATE TABLE "announcements" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "title" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "created_by_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE RESTRICT,
    "created_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    "is_global" BOOLEAN NOT NULL DEFAULT FALSE
);

-- Alter Notifications to add the FK reference now that announcements exists
ALTER TABLE "notifications" ADD FOREIGN KEY ("announcement_id") REFERENCES "announcements"("id") ON DELETE SET NULL;

CREATE TABLE "announcements_chapters" (
    "announcement_id" UUID NOT NULL REFERENCES "announcements"("id") ON DELETE CASCADE,
    "chapter_id" UUID NOT NULL REFERENCES "chapters"("id") ON DELETE CASCADE,
    PRIMARY KEY ("announcement_id", "chapter_id")
);

CREATE TABLE "announcements_committees" (
    "announcement_id" UUID NOT NULL REFERENCES "announcements"("id") ON DELETE CASCADE,
    "committee_id" UUID NOT NULL REFERENCES "committees"("id") ON DELETE CASCADE,
    PRIMARY KEY ("announcement_id", "committee_id")
);

CREATE TABLE "meetings" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "title" TEXT NOT NULL,
    "agenda" TEXT,
    "start_time" TIMESTAMP WITH TIME ZONE NOT NULL,
    "end_time" TIMESTAMP WITH TIME ZONE NOT NULL,
    "location_url" TEXT,
    "chapter_id" UUID REFERENCES "chapters"("id") ON DELETE CASCADE,
    "committee_id" UUID REFERENCES "committees"("id") ON DELETE CASCADE,
    "created_by_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE RESTRICT,
    "created_at" TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE TABLE "meeting_attendees" (
    "id" SERIAL PRIMARY KEY,
    "meeting_id" UUID NOT NULL REFERENCES "meetings"("id") ON DELETE CASCADE,
    "constituent_id" UUID NOT NULL REFERENCES "constituents"("id") ON DELETE CASCADE,
    "status" "ATTENDANCE_STATUS" NOT NULL DEFAULT 'INVITED',
    "is_required" BOOLEAN NOT NULL DEFAULT TRUE,
    UNIQUE ("meeting_id", "constituent_id")
);
